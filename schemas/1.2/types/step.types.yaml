# ============================================================================
# UBML Step Types Schema
# ============================================================================
# Defines step types and step-related constructs.
#
# ============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://ubml.talxis.com/schemas/1.2/types/step.types.yaml"
title: "UBML Step Types"
description: |
  Steps are the building blocks of processes.
  This schema defines Step, RACI, Approval, Review, and related types.

$defs:

  # ==========================================================================
  # MESSAGE DEFINITION
  # ==========================================================================

  Message:
    description: |
      Message sent during a step (for sequence diagrams).
      
      MESSAGES vs NOTIFICATIONS:
      ┌─────────────┬─────────────────────────────┬─────────────────────────────┐
      │             │ MESSAGES                    │ NOTIFICATIONS               │
      ├─────────────┼─────────────────────────────┼─────────────────────────────┤
      │ Purpose     │ Communication IS the work   │ Alerts ABOUT the work       │
      │ When        │ During step execution       │ At step lifecycle events    │
      │ Examples    │ "Send proposal to client"   │ "Alert when overdue"        │
      │ Diagrams    │ Sequence diagram arrows     │ Not shown in diagrams       │
      │ Simulation  │ Part of step duration       │ Zero duration, metadata     │
      └─────────────┴─────────────────────────────┴─────────────────────────────┘
      
      Use messages when the communication is the actual work being done.
      Use notifications for governance, monitoring, and RACI.informed automation.
    type: object
    additionalProperties: false
    required: [to, name]
    properties:
      to:
        description: "Recipient actor ID."
        $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      name:
        description: |
          Message name/content.
          
          Examples:
            - "Send proposal"
            - "Request approval"
            - "Notify completion"
        type: string
      channel:
        description: |
          Communication channel.
          
          Examples: "email", "API", "in-person", "phone", "portal"
        type: string

  # ==========================================================================
  # RACI MATRIX
  # ==========================================================================

  RACI:
    description: |
      RACI matrix for responsibility assignment.
      
      - Responsible: Who performs the work
      - Accountable: Who is ultimately answerable
      - Consulted: Who provides input (two-way communication)
      - Informed: Who is kept updated (one-way communication)
      
      CONNECTION TO NOTIFICATIONS:
      The 'informed' array defines WHO should be notified.
      The 'notifications' array on the step defines WHEN they are notified.
      When a notification omits 'recipients', it defaults to raci.informed.
      
      CONNECTION TO REVIEWS:
      The 'consulted' array defines default reviewers.
      When step.review omits 'reviewers', it defaults to raci.consulted.
    type: object
    additionalProperties: false
    x-ubml:
      humanName: "RACI Matrix"
      nestedProperties:
        - responsible
        - accountable
        - consulted
        - informed
      misplacementHint: "These properties belong inside 'raci:', not at the step level"
      misplacementExample: |
        raci:
          responsible: [AC00001]
    properties:
      responsible:
        description: |
          Actor IDs who perform the work.
          
          Best practice: Use roles, not individuals.
          Example: [AC010] where AC010 is "Sales Manager" role
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      accountable:
        description: |
          Actor IDs who are ultimately answerable.
          
          Best practice: Usually one person/role per step.
          The accountable party has final authority and sign-off.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      consulted:
        description: |
          Actor IDs whose opinions are sought.
          Used as default reviewers when step.review omits 'reviewers'.
          
          Two-way communication: you ask, they respond.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      informed:
        description: |
          Actor IDs who are kept up-to-date.
          Used as default recipients for step notifications when not specified.
          
          One-way communication: you tell, they receive.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"

  # ==========================================================================
  # LOOP DEFINITION
  # ==========================================================================

  Loop:
    description: |
      Rework/iteration modeling for simulation.
      
      Loops model repeated execution of a step:
      - repeat: Execute N times
      - rework: Probability-based retry (defect modeling)
      - forEach: Iterate over a collection
    type: object
    additionalProperties: false
    properties:
      kind:
        description: |
          Loop type:
          - none: no looping
          - repeat: repeat N times
          - rework: probability-based retry
          - forEach: iterate over collection
        type: string
        enum: [none, repeat, rework, forEach]
      over:
        description: |
          Entity ID or case attribute to iterate over (for forEach kind).
          
          Example: "orderLines" to iterate over each line item
        type: string
      max:
        description: "Maximum iterations."
        type: integer
        minimum: 1
      probability:
        description: |
          Probability of repeating (0-1, for repeat/rework kinds).
          
          Example: 0.1 means 10% chance of rework
        type: number
        minimum: 0
        maximum: 1

  # ==========================================================================
  # PROCESS CALL DEFINITION
  # ==========================================================================

  ProcessCall:
    description: |
      Cross-process invocation from a step.
      
      SEMANTICS:
      ┌─────────────────────────┬─────────────────────────────────────────┐
      │ Syntax                  │ Behavior                                │
      ├─────────────────────────┼─────────────────────────────────────────┤
      │ process: PR### alone    │ Synchronous call, step waits            │
      │ process: PR### + on:    │ Async trigger, step continues           │
      └─────────────────────────┴─────────────────────────────────────────┘
      
      BPMN PROJECTION:
      - Sync call (no 'on') → Call Activity
      - Async on: complete → Intermediate Signal Throw Event
      - Async on: error → Intermediate Error Throw Event
      
      Examples:
        # Synchronous subprocess call - step waits for completion
        calls:
          - process: PR00020
        
        # Async trigger on step completion
        calls:
          - process: PR00030
            on: complete
        
        # Conditional async trigger on error
        calls:
          - process: PR00040
            on: error
            condition: "severity == 'critical'"
    type: object
    additionalProperties: false
    required: [process]
    properties:
      process:
        description: "Process ID to invoke."
        $ref: "../defs/refs.defs.yaml#/$defs/ProcessRef"
      on:
        description: |
          Event that fires the call.
          
          INFERENCE RULE:
          - No 'on' property → synchronous call (step waits for subprocess)
          - Has 'on' property → asynchronous trigger (step continues)
          
          VALUES:
          - complete: fire when step completes successfully
          - error: fire when step encounters an error
          - timeout: fire when step times out
        type: string
        enum: [complete, error, timeout]
      condition:
        description: |
          Guard expression for conditional invocation.
          Call only executes if condition evaluates to true.
          
          Examples:
            condition: "order.value > 50000"
            condition: requiresEscalation
        $ref: "../defs/primitives.defs.yaml#/$defs/Expression"

  # ==========================================================================
  # SKILL REQUIREMENT
  # ==========================================================================

  SkillRequirement:
    description: |
      Skill required to perform a step.
      
      Used for resource matching in simulation.
      Step can only be performed by actors whose skill level >= required level.
      
      Example:
        skill: SK00001
        level: 3  # Requires at least Intermediate level
    type: object
    additionalProperties: false
    required: [skill]
    properties:
      skill:
        description: "Skill ID reference."
        $ref: "../defs/refs.defs.yaml#/$defs/SkillRef"
      level:
        description: |
          Required proficiency level (1-5).
          
          1 = Novice, 2 = Basic, 3 = Intermediate, 4 = Advanced, 5 = Expert
        type: integer
        minimum: 1
        maximum: 5

  # ==========================================================================
  # STEP TRIGGER
  # ==========================================================================

  StepTrigger:
    description: |
      When a step is activated.
      
      Triggers control how steps start:
      - immediate: Start as soon as predecessors complete
      - scheduled: Start after a delay
      - event: Start when an event occurs
    type: object
    additionalProperties: false
    properties:
      type:
        description: "Trigger type."
        type: string
        enum: [immediate, scheduled, event]
        default: immediate
      delay:
        description: |
          Delay before activation.
          
          Examples:
            delay: "30d"                        # fixed literal
            delay: { expr: "waitPeriod * 1.5" } # calculation
            delay: { expr: standardDelay }      # work attribute
        $ref: "../defs/primitives.defs.yaml#/$defs/Duration"
      relativeTo:
        description: "Step ID the delay is relative to."
        $ref: "../defs/refs.defs.yaml#/$defs/StepRef"
      condition:
        description: |
          Expression that must be true for trigger to fire.
          
          Examples:
            condition: "order.value > 10000"    # calculation
            condition: requiresFollowup         # work attribute
        $ref: "../defs/primitives.defs.yaml#/$defs/Expression"

  # ==========================================================================
  # BATCH DEFINITION
  # ==========================================================================

  Batch:
    description: |
      Batching configuration for steps that process items together.
      
      Used for manufacturing/service operations where items are
      processed in groups rather than individually.
      
      Example: Processing 10 orders at once in a batch print job
    type: object
    additionalProperties: false
    properties:
      size:
        description: "Number of items processed together."
        type: integer
        minimum: 1

  # ==========================================================================
  # NOTIFICATION DEFINITION
  # ==========================================================================

  Notification:
    description: |
      Notification configuration for alerting stakeholders about step events.
      
      NOTIFICATIONS vs MESSAGES:
      - Messages = communication IS the work (shown in sequence diagrams)
      - Notifications = system alerts ABOUT the work (governance/monitoring)
      
      RACI CONNECTION:
      When 'recipients' is omitted, notifications are sent to raci.informed.
      This makes the RACI matrix actionable for automated notifications.
      
      Examples:
        # Notify RACI.informed when step starts
        - trigger: onStart
        
        # Warn approvers 1 day before deadline
        - trigger: onDeadlineWarning
          threshold: "1d"
          recipients: [AC00002, AC007]
          priority: high
        
        # Notify customer on rejection
        - trigger: onOutcome
          outcome: rejected
          recipients: [AC00001]
    type: object
    additionalProperties: false
    required: [trigger]
    properties:
      trigger:
        description: |
          Step lifecycle event that triggers this notification.
        $ref: "../defs/shared.defs.yaml#/$defs/StepLifecycleEvent"
      outcome:
        description: |
          For trigger: onOutcome, which outcome triggers this notification.
          Must match an outcome defined in the step's approval.outcomes.
        type: string
      recipients:
        description: |
          Actor IDs to notify.
          If omitted, defaults to raci.informed.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      threshold:
        description: |
          For trigger: onDeadlineWarning, time before deadline to notify.
          Example: "2d" = notify 2 days before deadline expires.
        $ref: "../defs/primitives.defs.yaml#/$defs/DurationString"
      priority:
        description: "Notification urgency level."
        $ref: "../defs/shared.defs.yaml#/$defs/Priority"
      condition:
        description: |
          Guard expression - notification only sent if condition is true.
        $ref: "../defs/primitives.defs.yaml#/$defs/Expression"

  # ==========================================================================
  # APPROVAL DEFINITION
  # ==========================================================================

  Approval:
    description: |
      Approval configuration for steps requiring sign-off or authorization.
      
      Adds structured approval semantics to any step, enabling:
      - Multi-approver workflows with quorum rules
      - Explicit outcomes tied to routing decisions
      - Delegation support
      
      OUTCOMES:
      Define explicit outcomes (e.g., approved, rejected, returned) that
      can be referenced in link guards for routing:
      
        links:
          - from: ST015
            to: ST016
            guard: "step.outcome == 'approved'"
          - from: ST015
            to: ST010
            guard: "step.outcome == 'returned'"
      
      QUORUM:
      Use 'required' to specify how many approvers must agree:
      - required: 1 = any one approver (default)
      - required: 2 = at least 2 must approve
      - required: all = unanimous approval
    type: object
    additionalProperties: false
    required: [approvers]
    properties:
      approvers:
        description: |
          Actor IDs who can approve this step.
          At least one approver must be specified.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
        minItems: 1
      required:
        description: |
          How many approvers must approve for the step to complete.
          - number: exact count required (e.g., 2 means 2 of N must approve)
          - 'all': unanimous approval required
          - 'any': any single approver suffices (default)
        oneOf:
          - type: integer
            minimum: 1
          - type: string
            enum: [all, any]
        default: any
      outcomes:
        description: |
          Possible outcomes of the approval.
          These can be referenced in link guards for conditional routing.
          
          Recommended: Use standard outcomes (approved, rejected, returned,
          deferred, escalated, timeout). Custom outcomes allowed as strings.
        type: array
        items:
          type: string
        default: [approved, rejected]
      allowDelegation:
        description: |
          Whether approvers can delegate their approval to others.
          Useful for vacation coverage or workload balancing.
        type: boolean
        default: false
      allowReassignment:
        description: |
          Whether the approval can be reassigned to a different approver.
          Typically used when original approver is unavailable.
        type: boolean
        default: false
      requireComment:
        description: |
          Whether approvers must provide a comment with their decision.
          - never: comments optional (default)
          - onNegative: required when rejecting/returning
          - always: required for all outcomes
        $ref: "../defs/shared.defs.yaml#/$defs/CommentRequirement"
      deadline:
        description: |
          Time limit for approvers to make a decision.
          If breached, can trigger notifications or auto-outcomes.
        $ref: "../defs/primitives.defs.yaml#/$defs/DurationString"

  # ==========================================================================
  # REVIEW DEFINITION
  # ==========================================================================

  Review:
    description: |
      Review configuration for gathering feedback (non-blocking).
      
      REVIEW vs APPROVAL:
      ┌─────────────┬─────────────────────────────┬─────────────────────────────┐
      │             │ REVIEW                      │ APPROVAL                    │
      ├─────────────┼─────────────────────────────┼─────────────────────────────┤
      │ Blocking    │ No - process continues      │ Yes - gates progression     │
      │ Purpose     │ Gather feedback, comments   │ Authorize, sign-off         │
      │ Outcome     │ Feedback collected          │ Decision made               │
      │ RACI link   │ Defaults to Consulted       │ Specified explicitly        │
      │ Routing     │ No effect on flow           │ Guards control routing      │
      └─────────────┴─────────────────────────────┴─────────────────────────────┘
      
      RACI CONNECTION:
      When 'reviewers' is omitted, defaults to raci.consulted.
    type: object
    additionalProperties: false
    properties:
      reviewers:
        description: |
          Actor IDs who should provide feedback.
          If omitted, defaults to raci.consulted.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      required:
        description: |
          How many reviewers must respond.
          - number: exact count required
          - 'all': all reviewers must respond
          - 'any': at least one reviewer (default)
        oneOf:
          - type: integer
            minimum: 1
          - type: string
            enum: [all, any]
        default: any
      waitFor:
        description: |
          Number of reviews to wait for before step can complete.
          - 0 or omitted: step completes immediately, reviews are async
          - number: wait for N reviews before step completes
          - 'all': wait for all reviewers (makes review blocking)
        oneOf:
          - type: integer
            minimum: 0
          - type: string
            enum: [all]
        default: 0
      deadline:
        description: |
          Time limit for reviewers to respond.
          After deadline, step proceeds with whatever reviews are in.
        $ref: "../defs/primitives.defs.yaml#/$defs/DurationString"
      requireComment:
        description: |
          Whether reviewers must provide comments.
          - never: feedback optional (default)
          - onNegative: required when flagging issues/concerns
          - always: comments required from all reviewers
        $ref: "../defs/shared.defs.yaml#/$defs/CommentRequirement"

  # ==========================================================================
  # DEADLINE DEFINITION
  # ==========================================================================

  Deadline:
    description: |
      Contractual or SLA deadline for a step.
      Separate from 'duration' which is the expected time for simulation.
      
      Use deadline for:
      - External party response SLAs
      - Contractual completion requirements
      - Regulatory or procedural timeframes
    type: object
    additionalProperties: false
    required: [limit]
    properties:
      limit:
        description: "Maximum allowed duration from step start."
        $ref: "../defs/primitives.defs.yaml#/$defs/DurationString"
      procedureRef:
        description: |
          Reference to external procedure, regulation, or SLA.
          
          Examples:
            - "Building permit review - §123 Stavební zákon"
            - "SLA-RESP-4H"
            - "Contract clause 5.2.1"
            - "GDPR Art.17 - Right to erasure"
        type: string
      onBreach:
        description: "Actions when deadline is breached."
        type: object
        additionalProperties: false
        properties:
          notify:
            description: "Actor IDs to notify on breach."
            type: array
            items:
              $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
          outcome:
            description: |
              Outcome to apply when deadline breaches.
              Recommended: use 'timeout' from StandardOutcome.
            type: string

  # ==========================================================================
  # STEP DEFINITION
  # ==========================================================================

  Step:
    description: |
      A node in the work graph.
      
      Steps can represent:
      - action: work that transforms inputs to outputs
      - milestone: significant point in the process
      - decision: routing decision point
      - subprocess: grouped work (can contain nested steps)
      - wait: waiting for external event
      - handoff: transfer to another actor
      - start: process entry point
      - end: process exit point
    type: object
    additionalProperties: false
    required: [name, kind]
    properties:
      name:
        description: |
          Short label for diagrams (3-7 words).
          
          Examples:
            - "Review Purchase Order"
            - "Approve Budget"
            - "Dispatch Technician"
        type: string
      
      kind:
        description: |
          Step type. Most steps are 'action' (the default).
          
          WHEN TO USE EACH:
          - action: Work that transforms inputs to outputs (default)
          - decision: Routing choice with multiple outcomes
          - milestone: Significant checkpoint (zero duration)
          - wait: Pause for external event or time
          - handoff: Transfer to another team/actor
          - subprocess: Container for nested steps
          - start/end: Process boundaries
          
          COMMON MISTAKE: Using 'milestone' for approval gates.
          Use 'action' with 'approval:' instead.
          
          Examples of each:
            action: "Review Purchase Order", "Install Equipment"
            decision: "Route by Order Value", "Check Eligibility"
            milestone: "Contract Signed", "Phase 1 Complete"
            wait: "Wait for Parts Delivery", "Wait 30 Days"
            handoff: "Transfer to Field Team", "Escalate to Manager"
            subprocess: "Customer Onboarding", "Quality Inspection"
            start: "Service Request Received"
            end: "Service Complete"
        type: string
        enum: [action, milestone, decision, subprocess, wait, handoff, start, end]
        examples:
          - action
          - decision
          - milestone
        x-ubml:
          propertyNames: ["kind"]
          valueMistakes:
            task:
              value: "task"
              hint: "Use 'action' for work steps. 'task' is not a valid step kind."
            gateway:
              value: "gateway"
              hint: "Use 'decision' for branching points. BPMN 'gateway' maps to UBML 'decision'."
            activity:
              value: "activity"
              hint: "Use 'action' for activities. BPMN 'activity' maps to UBML 'action'."
            event:
              value: "event"
              hint: "Use 'start', 'end', 'wait', or 'milestone' instead. BPMN events map to specific UBML kinds."
            approval:
              value: "approval"
              hint: "Use 'action' with an 'approval:' section. Approval is not a step kind, it's a step property."
            review:
              value: "review"
              hint: "Use 'action' with a 'review:' section. Review is not a step kind, it's a step property."
      
      systems:
        description: |
          Software systems used in this step.
          References actors with type: system.
          
          For physical equipment, use 'equipment' instead.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/ActorRef"
      
      equipment:
        description: |
          Physical equipment used in this step.
          
          Equipment is separate from systems because:
          1. Equipment requires operators with specific skills
          2. Equipment has physical location constraints
          3. Simulation matches person with skill + available equipment
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/EquipmentRef"
      
      guard:
        description: |
          Condition for this step to execute.
          
          Examples:
            guard: "orderValue > 50000"
            guard: isHighValueEnterprise
        $ref: "../defs/primitives.defs.yaml#/$defs/Expression"
      
      duration:
        description: |
          Elapsed time for this step.
          
          Examples:
            duration: "2d"
            duration: { expr: "tri(d(1),d(2),d(4))" }
            duration: { expr: adjustedDuration }
        $ref: "../defs/primitives.defs.yaml#/$defs/Duration"
      
      effort:
        description: |
          Work time (may differ from duration if waiting involved).
          
          Examples:
            effort: "4h"
            effort: { expr: "baseEffort * 1.5" }
        $ref: "../defs/primitives.defs.yaml#/$defs/Duration"
      
      fixedCost:
        description: |
          Fixed cost for outsourced/third-party work.
          If not specified, cost is calculated from actor rates * effort.
        $ref: "../defs/primitives.defs.yaml#/$defs/Money"
      
      inputs:
        description: |
          Entities or documents consumed by this step.
          Input references are read-only and don't change document state.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/DataObjectInput"
      
      outputs:
        description: |
          Entities or documents produced or modified by this step.
          Document lifecycle progresses based on output ordering.
        type: array
        items:
          $ref: "../defs/refs.defs.yaml#/$defs/DataObjectOutput"
      
      messages:
        description: "Messages sent during this step (for sequence diagrams)."
        type: array
        items:
          $ref: "#/$defs/Message"
      
      raci:
        description: "RACI matrix for this step."
        $ref: "#/$defs/RACI"
      
      steps:
        description: |
          Inline nested steps (for subprocess kind).
          Mutually exclusive with 'calls'.
        type: object
        additionalProperties: false
        patternProperties:
          "^ST\\d{5,}$":
            $ref: "#/$defs/Step"
      
      calls:
        description: |
          Cross-process invocations from this step.
          
          SEMANTICS:
          - No 'on' property → synchronous call (step waits)
          - Has 'on' property → asynchronous trigger (step continues)
          
          Examples:
            # Sync call
            calls:
              - process: PR00020
            
            # Async trigger on completion
            calls:
              - process: PR00030
                on: complete
        type: array
        items:
          $ref: "#/$defs/ProcessCall"
      
      loop:
        description: "Rework/iteration configuration."
        $ref: "#/$defs/Loop"
      
      requiresSkills:
        description: "Skills required to perform this step."
        type: array
        items:
          $ref: "#/$defs/SkillRequirement"
      
      annotations:
        description: "Notes and markers attached to this step."
        type: array
        items:
          $ref: "../defs/shared.defs.yaml#/$defs/Annotation"
      
      trigger:
        description: "When this step is activated."
        $ref: "#/$defs/StepTrigger"
      
      batch:
        description: "Batching configuration for batch processing."
        $ref: "#/$defs/Batch"
      
      approval:
        description: |
          Approval configuration for steps requiring sign-off.
          When present, this step is treated as an approval gate.
        $ref: "#/$defs/Approval"
      
      review:
        description: |
          Review configuration for gathering non-blocking feedback.
          When reviewers omitted, defaults to raci.consulted.
        $ref: "#/$defs/Review"
      
      notifications:
        description: |
          Notifications sent at step lifecycle events.
          When recipients omitted, defaults to raci.informed.
        type: array
        items:
          $ref: "#/$defs/Notification"
      
      deadline:
        description: "Contractual or SLA deadline for this step."
        $ref: "#/$defs/Deadline"
      
      constraint:
        description: |
          Schedule constraint type for project planning.
          - asap: as soon as possible (default)
          - alap: as late as possible
          - mustStartOn: must start on constraintDate
          - mustFinishOn: must finish on constraintDate
          - startNoEarlierThan: cannot start before constraintDate
          - finishNoLaterThan: must finish by constraintDate
        type: string
        enum: [asap, alap, mustStartOn, mustFinishOn, startNoEarlierThan, finishNoLaterThan]
      
      constraintDate:
        description: "Date for schedule constraint (ISO 8601)."
        $ref: "../defs/primitives.defs.yaml#/$defs/DateString"
      
      description:
        description: "Longer description for reports and documentation."
        type: string
      
      tags:
        description: "Tags for filtering and views."
        type: array
        items:
          type: string
      
      custom:
        description: "User-defined custom fields."
        $ref: "../defs/shared.defs.yaml#/$defs/CustomFields"
