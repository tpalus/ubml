# ============================================================================
# UBML Mining Fragment Schema
# ============================================================================
# Defines process mining configuration and mappings.
#
# ============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://ubml.io/schemas/1.2/fragments/mining.fragment.yaml"
title: "UBML Mining Fragment"
description: |
  Process mining configuration for connecting UBML models with event log data.
  
  Process mining extracts insights from system event logs to:
  - Discover actual process flows
  - Compare reality vs. documented processes (conformance)
  - Identify bottlenecks and variations
  - Validate process improvements
  
  This fragment enables mapping between:
  - Event log activities → UBML steps
  - Event log resources → UBML actors
  - Event log attributes → UBML entities

$defs:

  # ==========================================================================
  # ACTIVITY MAPPING
  # ==========================================================================

  ActivityMapping:
    description: |
      Maps event log activity names to UBML step IDs.
      
      Activity names in event logs often differ from step names in the model.
      This mapping enables conformance checking and performance analysis.
      
      MAPPING TYPES:
      - exact: One-to-one mapping
      - pattern: Regex pattern matching
      - group: Multiple activities map to one step
      
      EXAMPLES:
      
      Exact mapping:
        - activity: "Create Purchase Order"
          step: ST00001
          type: exact
      
      Pattern mapping:
        - activity: "Approve*"
          step: ST005
          type: pattern
      
      Group mapping (multiple activities → one step):
        - activity: ["Review Level 1", "Review Level 2", "Final Review"]
          step: ST010
          type: group
    type: object
    additionalProperties: false
    required: [step]
    properties:
      activity:
        description: |
          Activity name(s) from the event log.
          Can be a single string, regex pattern, or array of strings.
        oneOf:
          - type: string
          - type: array
            items:
              type: string
      
      step:
        description: "UBML step ID this activity maps to."
        $ref: "../common/defs.schema.yaml#/$defs/StepRef"
      
      type:
        description: |
          Mapping type:
          - exact: Exact string match
          - pattern: Regex pattern
          - group: Multiple activities to one step
        type: string
        enum: [exact, pattern, group]
        default: exact
      
      description:
        description: "Description of the mapping logic."
        type: string

  # ==========================================================================
  # RESOURCE MAPPING
  # ==========================================================================

  ResourceMapping:
    description: |
      Maps event log resource identifiers to UBML actors.
      
      Resources in event logs are typically user IDs or role names.
      This mapping connects them to the actor model.
      
      EXAMPLES:
      
      Role-based mapping:
        - resource: "Approver"
          actor: AC00003
          type: role
      
      Individual mapping:
        - resource: "john.smith@company.com"
          actor: AC00001
          type: individual
    type: object
    additionalProperties: false
    required: [resource, actor]
    properties:
      resource:
        description: |
          Resource identifier from the event log.
          Can be a user ID, role name, or pattern.
        type: string
      
      actor:
        description: "UBML actor ID this resource maps to."
        $ref: "../common/defs.schema.yaml#/$defs/ActorRef"
      
      type:
        description: |
          Mapping type:
          - role: Maps a role/group to an actor
          - individual: Maps a specific user to an actor
          - pattern: Regex pattern for multiple users
        type: string
        enum: [role, individual, pattern]
        default: role
      
      description:
        description: "Description of the mapping logic."
        type: string

  # ==========================================================================
  # ATTRIBUTE MAPPING
  # ==========================================================================

  AttributeMapping:
    description: |
      Maps event log attributes to UBML entity fields.
      
      Event logs often contain case-level attributes that
      correspond to entity fields in the process model.
      
      EXAMPLE:
        - attribute: "order_value"
          entity: EN00001
          field: totalValue
          transform: none
    type: object
    additionalProperties: false
    required: [attribute]
    properties:
      attribute:
        description: "Attribute name in the event log."
        type: string
      
      entity:
        description: "UBML entity this attribute belongs to."
        $ref: "../common/defs.schema.yaml#/$defs/EntityRef"
      
      field:
        description: "Field name within the entity."
        type: string
      
      transform:
        description: |
          Transformation to apply:
          - none: Use as-is
          - uppercase: Convert to uppercase
          - lowercase: Convert to lowercase
          - numeric: Parse as number
          - date: Parse as date
        type: string
        enum: [none, uppercase, lowercase, numeric, date]
        default: none
      
      description:
        description: "Description of the attribute meaning."
        type: string

  # ==========================================================================
  # MINING SOURCE
  # ==========================================================================

  MiningSource:
    description: |
      Configuration for a process mining data source.
      
      A mining source defines:
      - Where to get the event log data
      - How to interpret the data (column mappings)
      - How to map activities/resources to the UBML model
      
      SUPPORTED SOURCE TYPES:
      - csv: CSV file with standard event log columns
      - database: Direct database connection
      - api: REST API endpoint
      - xes: XES (IEEE 1849) standard format
      
      EXAMPLE - CSV Source:
      
        MS001:
          name: "SAP Order Log Export"
          description: "Monthly export from SAP order processing"
          type: csv
          
          columns:
            caseId: "Order_Number"
            activity: "Activity_Name"
            timestamp: "Event_Time"
            resource: "User_ID"
          
          timestampFormat: "YYYY-MM-DD HH:mm:ss"
          
          filters:
            - column: "Order_Type"
              operator: equals
              value: "Standard"
          
          activityMappings:
            - activity: "Create Sales Order"
              step: ST00001
            - activity: "Credit Check"
              step: ST00002
          
          resourceMappings:
            - resource: "OrderClerk"
              actor: AC00001
    type: object
    additionalProperties: false
    required: [name, type]
    properties:
      name:
        description: "Data source name."
        type: string
      
      description:
        description: "Data source description."
        type: string
      
      type:
        description: "Data source type."
        type: string
        enum: [csv, database, api, xes]
      
      # Connection configuration (type-specific)
      connection:
        description: |
          Connection configuration (for database/api types).
        type: object
        additionalProperties: true
        properties:
          host:
            type: string
          port:
            type: integer
          database:
            type: string
          table:
            type: string
          url:
            type: string
      
      # Column mappings (for CSV/database)
      columns:
        description: |
          Column name mappings for event log fields.
        type: object
        additionalProperties: false
        properties:
          caseId:
            description: "Column containing case/process instance ID."
            type: string
          activity:
            description: "Column containing activity name."
            type: string
          timestamp:
            description: "Column containing event timestamp."
            type: string
          startTimestamp:
            description: "Column containing activity start time (if separate)."
            type: string
          endTimestamp:
            description: "Column containing activity end time (if separate)."
            type: string
          resource:
            description: "Column containing resource/user identifier."
            type: string
          lifecycle:
            description: "Column containing lifecycle transition (start/complete)."
            type: string
      
      timestampFormat:
        description: |
          Timestamp format string.
          Uses standard date format patterns.
          
          Examples:
            "YYYY-MM-DD HH:mm:ss"
            "DD/MM/YYYY HH:mm"
            "ISO8601"
        type: string
      
      filters:
        description: |
          Filters to apply when loading data.
        type: array
        items:
          type: object
          additionalProperties: false
          required: [column, operator, value]
          properties:
            column:
              type: string
            operator:
              type: string
              enum: [equals, not_equals, contains, starts_with, ends_with, greater_than, less_than]
            value:
              oneOf:
                - type: string
                - type: number
      
      process:
        description: "UBML process this source provides data for."
        $ref: "../common/defs.schema.yaml#/$defs/ProcessRef"
      
      activityMappings:
        description: "Activity to step mappings."
        type: array
        items:
          $ref: "#/$defs/ActivityMapping"
      
      resourceMappings:
        description: "Resource to actor mappings."
        type: array
        items:
          $ref: "#/$defs/ResourceMapping"
      
      attributeMappings:
        description: "Attribute to entity field mappings."
        type: array
        items:
          $ref: "#/$defs/AttributeMapping"
      
      refreshSchedule:
        description: |
          Schedule for refreshing data.
          Cron-like expression or predefined values.
          
          Examples: "daily", "weekly", "0 0 * * *"
        type: string
      
      lastRefresh:
        description: "When data was last refreshed."
        type: string
        format: date-time
      
      recordCount:
        description: "Number of events in the source."
        type: integer
        minimum: 0
      
      caseCount:
        description: "Number of unique cases in the source."
        type: integer
        minimum: 0
      
      dateRange:
        description: "Date range covered by the data."
        type: object
        additionalProperties: false
        properties:
          from:
            type: string
            format: date
          to:
            type: string
            format: date
      
      quality:
        description: |
          Data quality metrics.
        type: object
        additionalProperties: false
        properties:
          completeness:
            description: "Percentage of complete cases."
            type: number
            minimum: 0
            maximum: 100
          unmappedActivities:
            description: "Count of activities not mapped to steps."
            type: integer
            minimum: 0
          unmappedResources:
            description: "Count of resources not mapped to actors."
            type: integer
            minimum: 0
      
      tags:
        description: "Tags for filtering and views."
        type: array
        items:
          type: string
      
      custom:
        description: "User-defined custom fields."
        $ref: "../common/defs.schema.yaml#/$defs/CustomFields"
