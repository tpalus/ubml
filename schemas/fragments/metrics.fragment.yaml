# ============================================================================
# UBML Metrics Fragment Schema
# ============================================================================
# Defines KPIs, metrics, and ROI analysis structures.
#
# ============================================================================

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://ubml.io/schemas/1.1/fragments/metrics.fragment.yaml"
title: "UBML Metrics Fragment"
description: |
  Metrics and measurement structures for process performance,
  business outcomes, and ROI analysis.
  
  This fragment defines:
  - KPI: Key Performance Indicators with targets and thresholds
  - ROI: Return on Investment analysis structure

$defs:

  # ==========================================================================
  # KPI THRESHOLD
  # ==========================================================================

  KPIThreshold:
    description: |
      A threshold level for KPI performance evaluation.
      
      Thresholds define the boundaries between performance levels.
      Typically used for traffic-light indicators (red/amber/green).
    type: object
    additionalProperties: false
    required: [level, value]
    properties:
      level:
        description: |
          Threshold level name.
          Common values: "red", "amber", "green" or "critical", "warning", "good"
        type: string
      
      value:
        description: "Threshold boundary value."
        type: number
      
      operator:
        description: |
          Comparison operator:
          - gte: Greater than or equal (green if >= value)
          - lte: Less than or equal (green if <= value)
          - eq: Equal to
        type: string
        enum: [gte, lte, eq]
        default: gte
        x-ubml:
          propertyNames: ["operator"]
          valueMistakes:
            ">":
              value: ">"
              hint: "Use 'gte' (greater than or equal) not '>'."
            ">=":
              value: ">="
              hint: "Use 'gte' for greater than or equal."
            "<":
              value: "<"
              hint: "Use 'lte' (less than or equal) not '<'."
            "<=":
              value: "<="
              hint: "Use 'lte' for less than or equal."
            "==":
              value: "=="
              hint: "Use 'eq' for equality comparison."
            equals:
              value: "equals"
              hint: "Use 'eq' for equality comparison."
      
      color:
        description: |
          Display color for this threshold level.
          
          Example: "#FF0000" for red, "#00FF00" for green
        type: string

  # ==========================================================================
  # KPI
  # ==========================================================================

  KPI:
    description: |
      Key Performance Indicator definition.
      
      KPIs are quantifiable measures used to evaluate success
      against objectives. They can be attached to:
      - Processes (process performance)
      - Steps (step performance)
      - Value streams (end-to-end performance)
      - Capabilities (capability performance)
      
      KPI TYPES:
      - outcome: Measures end results (revenue, customer satisfaction)
      - process: Measures process performance (cycle time, error rate)
      - leading: Predicts future outcomes (pipeline value, order backlog)
      - lagging: Measures past results (completed orders, revenue)
      
      EXAMPLES:
      
      Cycle time KPI:
        KP00001:
          name: "Order Processing Cycle Time"
          description: "End-to-end time from order to shipment"
          type: process
          unit: hours
          target: 24
          thresholds:
            - level: red
              value: 48
              operator: gte
            - level: amber
              value: 24
              operator: gte
            - level: green
              value: 24
              operator: lte
      
      Quality KPI:
        KP00002:
          name: "First Pass Yield"
          description: "Percentage of orders completed without errors"
          type: process
          unit: percent
          target: 98
          baseline: 92
    type: object
    additionalProperties: false
    required: [name]
    properties:
      name:
        description: "KPI name."
        type: string
      
      description:
        description: "Detailed KPI description."
        type: string
      
      type:
        description: |
          KPI type classification.
        type: string
        enum: [outcome, process, leading, lagging]
        x-ubml:
          propertyNames: ["type"]
          valueMistakes:
            kpi:
              value: "kpi"
              hint: "Specify KPI type: 'outcome', 'process', 'leading', or 'lagging'."
            metric:
              value: "metric"
              hint: "Specify KPI type: 'outcome', 'process', 'leading', or 'lagging'."
            result:
              value: "result"
              hint: "Use 'outcome' or 'lagging' for result-based KPIs."
            performance:
              value: "performance"
              hint: "Use 'process' for performance metrics, or 'outcome' for business outcomes."
            efficiency:
              value: "efficiency"
              hint: "Use 'process' for efficiency metrics."
      
      category:
        description: |
          Category for grouping KPIs.
          
          Examples: "quality", "speed", "cost", "satisfaction", "compliance"
        type: string
      
      unit:
        description: |
          Unit of measurement.
          
          Examples: "hours", "days", "percent", "count", "currency"
        type: string
      
      formula:
        description: |
          Calculation formula for derived KPIs.
          
          Example: "(completed_orders / total_orders) * 100"
        type: string
      
      baseline:
        description: |
          Baseline/current value for comparison.
          Used as the "as-is" reference point.
        type: number
      
      target:
        description: |
          Target value to achieve.
          Used as the "to-be" goal.
        type: number
      
      stretch:
        description: |
          Stretch/aspirational target.
          Represents excellent performance.
        type: number
      
      thresholds:
        description: |
          Performance thresholds for evaluation.
        type: array
        items:
          $ref: "#/$defs/KPIThreshold"
      
      frequency:
        description: |
          Measurement frequency.
          
          Examples: "real-time", "daily", "weekly", "monthly", "quarterly"
        type: string
      
      source:
        description: |
          Data source for this KPI.
          
          Example: "ERP system", "CRM reports", "Manual tracking"
        type: string
      
      process:
        description: "Process this KPI measures."
        $ref: "../common/defs.schema.yaml#/$defs/ProcessRef"
      
      step:
        description: "Step this KPI measures."
        $ref: "../common/defs.schema.yaml#/$defs/StepRef"
      
      owner:
        description: "KPI owner responsible for tracking."
        $ref: "../common/defs.schema.yaml#/$defs/ActorRef"
      
      tags:
        description: "Tags for filtering and views."
        type: array
        items:
          type: string
      
      custom:
        description: "User-defined custom fields."
        $ref: "../common/defs.schema.yaml#/$defs/CustomFields"

  # ==========================================================================
  # ROI COMPONENT
  # ==========================================================================

  ROIComponent:
    description: |
      A component of ROI analysis (cost or benefit).
      
      Each component represents either:
      - A cost item (investment required)
      - A benefit item (value delivered)
    type: object
    additionalProperties: false
    required: [name, amount]
    properties:
      name:
        description: "Component name."
        type: string
      
      description:
        description: "Component description."
        type: string
      
      amount:
        description: "Monetary value of this component."
        $ref: "../common/defs.schema.yaml#/$defs/Money"
      
      timing:
        description: |
          When this cost/benefit occurs.
          
          Values:
          - one-time: Single occurrence
          - recurring: Repeats at specified frequency
        type: string
        enum: [one-time, recurring]
      
      frequency:
        description: |
          For recurring items: how often.
          
          Examples: "monthly", "quarterly", "annually"
        type: string
      
      startPeriod:
        description: |
          When this component starts (period number).
          Period 0 = project start, 1 = first period after go-live.
        type: integer
        minimum: 0
      
      endPeriod:
        description: |
          When this component ends (for recurring items).
        type: integer
        minimum: 0
      
      confidence:
        description: |
          Confidence in this estimate (0-1).
          1.0 = highly certain, 0.5 = rough estimate
        type: number
        minimum: 0
        maximum: 1
      
      category:
        description: |
          Category for grouping.
          
          Cost categories: "labor", "technology", "consulting", "training"
          Benefit categories: "cost-savings", "revenue", "productivity", "risk-reduction"
        type: string
      
      assumptions:
        description: |
          Key assumptions underlying this estimate.
        type: array
        items:
          type: string

  # ==========================================================================
  # ROI ANALYSIS
  # ==========================================================================

  ROI:
    description: |
      Return on Investment analysis structure.
      
      ROI analysis quantifies the business case for process improvements
      or initiatives by comparing costs against benefits.
      
      KEY METRICS:
      - ROI %: (Total Benefits - Total Costs) / Total Costs Ã— 100
      - NPV: Net Present Value of benefits minus costs
      - Payback Period: Time to recover initial investment
      - IRR: Internal Rate of Return
      
      EXAMPLE:
      
        ROI001:
          name: "Process Automation Business Case"
          description: "ROI analysis for automating order processing"
          analysisPeriod: 36
          discountRate: 0.08
          
          costs:
            - name: "Automation Software License"
              amount: 50000
              timing: one-time
              category: technology
            - name: "Implementation Services"
              amount: 30000
              timing: one-time
              category: consulting
            - name: "Annual Maintenance"
              amount: 10000
              timing: recurring
              frequency: annually
              category: technology
          
          benefits:
            - name: "FTE Reduction"
              amount: 60000
              timing: recurring
              frequency: annually
              category: cost-savings
            - name: "Error Reduction"
              amount: 15000
              timing: recurring
              frequency: annually
              category: cost-savings
    type: object
    additionalProperties: false
    required: [name, costs, benefits]
    properties:
      name:
        description: "Analysis name."
        type: string
      
      description:
        description: "Analysis description."
        type: string
      
      analysisPeriod:
        description: |
          Time horizon for analysis in months.
          Typical values: 12, 24, 36, 60 months.
        type: integer
        minimum: 1
      
      discountRate:
        description: |
          Discount rate for NPV calculation (decimal).
          0.08 = 8% annual discount rate.
        type: number
        minimum: 0
        maximum: 1
      
      costs:
        description: "Cost components of the investment."
        type: array
        items:
          $ref: "#/$defs/ROIComponent"
      
      benefits:
        description: "Benefit components from the investment."
        type: array
        items:
          $ref: "#/$defs/ROIComponent"
      
      assumptions:
        description: |
          Key assumptions for the analysis.
        type: array
        items:
          type: object
          additionalProperties: false
          required: [name, value]
          properties:
            name:
              type: string
            value:
              type: string
            sensitivity:
              description: "Impact if assumption is wrong: high, medium, low"
              type: string
              enum: [high, medium, low]
      
      risks:
        description: |
          Risks that could affect the ROI.
        type: array
        items:
          type: object
          additionalProperties: false
          required: [name]
          properties:
            name:
              type: string
            description:
              type: string
            probability:
              type: string
              enum: [low, medium, high]
            impact:
              type: string
              enum: [low, medium, high]
            mitigation:
              type: string
      
      results:
        description: |
          Calculated results (typically filled by tooling).
        type: object
        additionalProperties: false
        properties:
          totalCosts:
            $ref: "../common/defs.schema.yaml#/$defs/Money"
          totalBenefits:
            $ref: "../common/defs.schema.yaml#/$defs/Money"
          netBenefit:
            $ref: "../common/defs.schema.yaml#/$defs/Money"
          roiPercent:
            type: number
          npv:
            $ref: "../common/defs.schema.yaml#/$defs/Money"
          paybackMonths:
            type: integer
          irr:
            type: number
      
      owner:
        description: "Analysis owner."
        $ref: "../common/defs.schema.yaml#/$defs/ActorRef"
      
      approvedBy:
        description: "Who approved the business case."
        $ref: "../common/defs.schema.yaml#/$defs/ActorRef"
      
      approvedAt:
        description: "When the business case was approved."
        type: string
        format: date
      
      tags:
        description: "Tags for filtering and views."
        type: array
        items:
          type: string
      
      custom:
        description: "User-defined custom fields."
        $ref: "../common/defs.schema.yaml#/$defs/CustomFields"
